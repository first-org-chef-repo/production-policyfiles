# This is a basic workflow to help you get started with Actions

name: Converge All Nodes

on:
  push:
    branches: 
      - main
    paths:
      - 'policyfiles/**'
  workflow_dispatch:
  
jobs:
  Setup-ChefWorkstation:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - name: Checking if installation required
        continue-on-error: true
        id: check
        run: sudo dpkg -l | grep chef
      - name: Installing ChefWorkstation v21.2.278
        if: steps.check.outcome == 'failure'
        run: |
          wget -q https://packages.chef.io/files/stable/chef-workstation/21.2.278/ubuntu/20.04/chef-workstation_21.2.278-1_amd64.deb
          sudo dpkg -i chef-workstation_21.2.278-1_amd64.deb
          chef -v

  Push-Policyfiles-to-ChefServer:
    runs-on: self-hosted
    needs: Setup-ChefWorkstation
    steps:
      - name: Create/push Policyfile.lock to ChefServer
        run: |
          chef update policyfiles/db-server.rb -c /home/r-goto/.chef/config.rb
          chef update policyfiles/web-server.rb -c /home/r-goto/.chef/config.rb
          chef push production policyfiles/db-server.rb -c /home/r-goto/.chef/config.rb
          chef push production policyfiles/web-server.rb -c /home/r-goto/.chef/config.rb
  
  Converge-Nodes:
    environment:
      name: production
      url: https://github.com/first-org-chef-repo/production-policyfiles/tree/main/policyfiles
    runs-on: self-hosted
    needs: Push-Policyfiles-to-ChefServer
    steps:
      - name: Converge all production nodes
        run: 
          knife ssh 'policy_group:production' 'sudo chef-client' -c /home/r-goto/.chef/config.rb
  Test:
    runs-on: self-hosted
    needs: Converge-Nodes
    steps:
      - name: Run Inspec
        continue-on-error: true
        run: |
          for i in `knife search 'policy_group:production AND policy_name:web-server' -i -c /home/r-goto/.chef/config.rb | sort`; do inspec exec $GITHUB_WORKSPACE/test/setup_nginx_test.rb --target ssh://r-goto@$i -i ~/.ssh/nodes_shared || echo 'Inspec failure!'; done
          for i in `knife search 'policy_group:production AND policy_name:db-server' -i -c /home/r-goto/.chef/config.rb | sort`; do inspec exec $GITHUB_WORKSPACE/test/setup_postgresql_test.rb --target ssh://r-goto@$i -i ~/.ssh/nodes_shared || echo 'Inspec failure!'; done
